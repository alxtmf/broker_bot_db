
**Справочник «Целевые системы»** (CLS_TARGET_SYSTEM). В справочнике
содержатся данные о тех системах, сообщения от которых будут идти в боты
или которые будут отвечать на запросы

  Атрибут       Тип           Описание
  ------------- ------------- -------------------------------------------------------
  UUID          uuid          Уникальный идентификатор (генерируется автоматически)
  code          varchar(15)   Код
  Name          text          Наименование
  date_create   Timestamp     Время создания (генерируется автоматически)
  Is_deleted    boolean       Пометка логического удаления, true - удалено

**Справочник «Типы событий»** (CLS_EVENT_TYPE). События целевых систем,
по которым будут приходить уведомления.

+------------------+-------------+-----------------------------------+
| Атрибут          | Тип         | Описание                          |
+==================+=============+===================================+
| UUID             | uuid        | Уникальный идентификатор          |
+------------------+-------------+-----------------------------------+
| code             | varchar(15) | Код                               |
+------------------+-------------+-----------------------------------+
| Name             | text        | Наименование                      |
+------------------+-------------+-----------------------------------+
| Id_target_system | uuid        | Идентификатор целевой системы     |
+------------------+-------------+-----------------------------------+
| Id_parent        | uuid        | Тип события-родитель т.е элемент  |
|                  |             | более верхнего уровня иерархии в  |
|                  |             | CLS_EVENT_TYPE                    |
+------------------+-------------+-----------------------------------+
| date_create      | Timestamp   | Время создания (генерируется      |
|                  |             | автоматически)                    |
+------------------+-------------+-----------------------------------+
| Is_deleted       | boolean     | Пометка логического удаления,     |
|                  |             | true - удалено                    |
+------------------+-------------+-----------------------------------+
| type             | integer     | 0 -- event (Событие т.е данные от |
|                  |             | целевой системы отправляются в    |
|                  |             | мессенджер)                       |
|                  |             |                                   |
|                  |             | 1 -- request (Запрос из           |
|                  |             | мессенджера отправляется в        |
|                  |             | целевую систему)                  |
+------------------+-------------+-----------------------------------+

Справочник «Мессенджеры» (CLS_MESSENGER). Справочник доступных в системе
мессенджеров

  Атрибут       Тип           Описание
  ------------- ------------- ----------------------------------------------
  UUID          uuid          Уникальный идентификатор
  code          varchar(15)   Код
  Name          text)         Наименование
  date_create   Timestamp     Время создания (генерируется автоматически)
  Is_deleted    boolean       Пометка логического удаления, true - удалено

Справочник «Пользователи» (CLS_USER). Пользователи брокер-бота с учетом
соответствия пользователям целевых систем и мессенджеров

  Атрибут         Тип           Описание
  --------------- ------------- ----------------------------------------------
  UUID            uuid          Уникальный идентификатор
  code            varchar(15)   Код
  login           text          Логин
  firstname       text          Имя
  lastname        text          Фамилия
  patronymic      text          Отчество
  email           text          Почта
  identificator   varchar(32)   Идентификатор для передачи целевым системам
  date_create     Timestamp     Время создания (генерируется автоматически)
  Is_deleted      boolean       Пометка логического удаления, true - удалено

Регистр «Пользователи целевых систем» (REG_TARGET_SYSTEM_USER). --
Соответствие пользователя брокер-бота пользователям целевых систем.

  Атрибут            Тип         Описание
  ------------------ ----------- ----------------------------------------------------------------------
  UUID               uuid        Уникальный идентификатор
  date_create        Timestamp   Время создания
  Id_target_system   uuid        Идентификатор целевой системы
  Id_user            uuid        Идентификатор пользователя, назначается при привязке администратором
  login              text        Логин
  Outer_id           text        Идентификатор пользователя из целевой системы
  firstname          text        Имя
  lastname           text        Фамилия
  patronymic         text        Отчество
  email              text        Почта
  Is_deleted         boolean     Пометка логического удаления, true - удалено

Регистр «Пользователи мессенджеров» (REG_MESSENGER_USER). --
Соответствие пользователя брокер-бота пользователям мессенджеров.

  Атрибут        Тип         Описание
  -------------- ----------- -------------------------------------------------------------------------------------------------------------------------------------------
  UUID           uuid        Уникальный идентификатор
  date_create    Timestamp   Время создания
  Id_messenger   uuid        Идентификатор мессенджера
  Id_user        uuid        Идентификатор пользователя, назначается при автоматической регистрации через сервис регистрации, после ввода кода доступа (identificator)
  Outer_id       text        Идентификатор пользователя из мессенджера
  settings       jsonb       Данные пользователя в конкретном мессенджере
  Is_deleted     boolean     Пометка логического удаления, true - удалено

Справочник «Боты» (CLS_BOT). Справочник доступных в системе ботов и
настроек, необходимых для отправки им сообщений

  Атрибут        Тип            Описание
  -------------- -------------- ------------------------------------------------------------------------
  UUID           uuid           Уникальный идентификатор
  code           varchar(512)   Код
  Name           text           Наименование
  Id_messenger   uuid           Идентификатор мессенджера
  settings       jsonb          Настройки и реквизиты, необходимые для работы в конкретном мессенджере
  date_create    Timestamp      Время создания (генерируется автоматически)
  Is_deleted     boolean        Пометка логического удаления, true - удалено

Регистр «Маршруты» (REG_MESSAGE_ROUTE). Описание того, какие
пользователи каких целевых систем получают определенные типы сообщений в
определенные мессенджеры

  Атрибут            Тип         Описание
  ------------------ ----------- -----------------------------------------------------------------------------------------------------------------------
  UUID               uuid        Уникальный идентификатор
  date_create        Timestamp   Время создания
  Date_activation    Timestamp   Время активации
  Id_bot             uuid        Идентификатор бота
  Id_messenger       uuid        Идентификатор мессенджера (берется на основе данных бота)
  Id_event_type      uuid        Идентификатор типа события
  Id_target_system   uuid        Идентификатор целевой системы (берется на основе данных типа события)
  Id_user            uuid        Идентификатор пользователя
  Is_deleted         boolean     Пометка логического удаления, true -- удалено в случае, если пользователь удален, бот удален, целевая система удалена

Регистр «Отправляемые сообщения» (REG_SENT_MESSAGE). - Сообщения,
генерируемые целевыми системами для отправки.

+--------------------+-------------+---------------------------------+
| Атрибут            | Тип         | Описание                        |
+====================+=============+=================================+
| UUID               | uuid        | Уникальный идентификатор        |
+--------------------+-------------+---------------------------------+
| date_create        | timestamp   | Время создания                  |
+--------------------+-------------+---------------------------------+
| id_event_type      | uuid        | Идентификатор типа события      |
+--------------------+-------------+---------------------------------+
| id_target_system   | uuid        | Идентификатор целевой системы   |
|                    |             | (берется на основе данных типа  |
|                    |             | события)                        |
+--------------------+-------------+---------------------------------+
| id_user            | uuid        | Идентификатор пользователя      |
|                    |             |                                 |
|                    |             | (Определяется по поступающему   |
|                    |             | на вход outer_id)               |
+--------------------+-------------+---------------------------------+
| text               | text        | Текст сообщения, полученный из  |
|                    |             | целевой системы                 |
+--------------------+-------------+---------------------------------+
| status             | integer     | Статус обработки                |
|                    |             |                                 |
|                    |             | 0 -- создано (т.е пришло из     |
|                    |             | целевой системы)                |
|                    |             |                                 |
|                    |             | 1 -- отправлено (т.е успешно    |
|                    |             | отправлено в мессенджер)        |
|                    |             |                                 |
|                    |             | 2 -- при отправке произошла     |
|                    |             | ошибка на стороне брокер бота   |
|                    |             |                                 |
|                    |             | 3 -- пришла ошибка отправки     |
|                    |             | сообщения от бота               |
+--------------------+-------------+---------------------------------+
| id_incom_request   | uuid        | Идентификатор запроса           |
|                    |             | (заполняется в случае, если     |
|                    |             | сообщение сгенерировано в       |
|                    |             | результате запроса)             |
+--------------------+-------------+---------------------------------+
| Attached_file      | text        | Относительный путь к            |
|                    |             | сохраняемому файлу, включающий  |
|                    |             | имя файла с расширением         |
+--------------------+-------------+---------------------------------+
| Attached_file_type | Varchar(10) | Расширение файла                |
+--------------------+-------------+---------------------------------+
| Attached_file_size | integer     | Размер файла                    |
+--------------------+-------------+---------------------------------+
| Attached_file_hash | text        | Хэш от файла                    |
+--------------------+-------------+---------------------------------+

Регистр читают обработчики отправки сообщений в боты разных
мессенджеров. Для каждого мессенджера свой обработчик сообщений.
Обработчик сообщений читает записи со статусом 0,2,3 и пытается
отправить их. По результату отправки проставляется статус.

Регистр периодически (периодичность более 1 суток) очищается от записей
со статусом равным 1.

Регистр периодически (периодичность более 7 суток) очищается от записей
со статусом равным 2,3.

Регистр «Поступающие запросы» (REG_INCOM_REQUEST). Запросы от
пользователей ботов к целевым системам

+------------------+-----------+-------------------------------------+
| Атрибут          | Тип       | Описание                            |
+==================+===========+=====================================+
| UUID             | uuid      | Уникальный идентификатор            |
+------------------+-----------+-------------------------------------+
| date_create      | Timestamp | Время создания                      |
+------------------+-----------+-------------------------------------+
| Id_event_type    | uuid      | Идентификатор типа запроса          |
|                  |           | (CLS_EVENT_TYPE)                    |
+------------------+-----------+-------------------------------------+
| Id_target_system | uuid      | Идентификатор целевой системы       |
|                  |           | (берется на основе данных типа      |
|                  |           | события)                            |
+------------------+-----------+-------------------------------------+
| Id_bot           | uuid      | Идентификатор бота                  |
+------------------+-----------+-------------------------------------+
| Id_messenger     | uuid      | Идентификатор мессенджера (берется  |
|                  |           | на основе данных бота)              |
+------------------+-----------+-------------------------------------+
| Id_user          | uuid      | Идентификатор пользователя          |
+------------------+-----------+-------------------------------------+
| status           | integer   | Статус обработки                    |
|                  |           |                                     |
|                  |           | 0 -- создано (т.е пришло от бота)   |
|                  |           |                                     |
|                  |           | 1 -- отправлено (прочитано целевой  |
|                  |           | системой)                           |
|                  |           |                                     |
|                  |           | 2 -- получен ответ из целевой       |
|                  |           | системы (имеется запись в           |
|                  |           | REG_SENT_MESSAGE)                   |
|                  |           |                                     |
|                  |           | 3 -- ответ отправлен в мессенджер   |
+------------------+-----------+-------------------------------------+

Записи регистра со статусом 0 доступны на чтение для целевой системы.
Если целевая система отправила запрос и ей сгенерирован ответ, то запись
переводится в статус 1. Запись переводится в статус 3, при обработке
REG_SENT_MESSAGE обработчиками.

Регистр периодически (периодичность более 1 суток) очищается от записей
со статусом равным 2 в рамках очистки REG_SENT_MESSAGE.

Регистр периодически (периодичность более 7 суток) очищается от записей
со статусом равным 1.

Представление «Маршруты отправки сообщений» V\_ MESSENGER_USER\_
MESSAGE_ROUTE (Результат внутреннего соединения записей из
REG_MESSENGER_USER, REG_MESSAGE_ROUTE и CLS_BOT по Id_user и
Id_messenger для записей с Is_deleted = false, CLS_BOT присоединяется по
Id_bot B REG_MESSAGE_ROUTE.date_activation is not null)

  Атрибут                Тип     Описание
  ---------------------- ------- --------------------------------------------------------------------------------------------
  Id_bot                 uuid    Идентификатор бота из REG_MESSAGE_ROUTE
  Id_messenger           uuid    Идентификатор мессенджера (берется на основе данных бота) из REG_MESSAGE_ROUTE
  Id_event_type          uuid    Идентификатор типа события из REG_MESSAGE_ROUTE
  Id_parent_event_type   uuid    Идентификатор родителя типа события из REG_MESSAGE_ROUTE
  Id_target_system       uuid    Идентификатор целевой системы (берется на основе данных типа события) из REG_MESSAGE_ROUTE
  Id_user                uuid    Идентификатор пользователя из REG_MESSAGE_ROUTE
  Outer_id               text    Идентификатор пользователя из мессенджера из REG_MESSENGER_USER
  User_settings          jsonb   Данные пользователя в конкретном мессенджере из REG_MESSENGER_USER
  Bot_settings           jsonb   Настройки и реквизиты, необходимые для работы в конкретном мессенджере из CLS_BOT
  Bot_Name               text    Наименование Бота из CLS_BOT
